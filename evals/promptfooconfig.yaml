# Promptfoo configuration for Habit Bot LLM evaluation
# Run all prompts against one model before switching to reduce GPU memory thrashing

description: "Habit Bot LLM Prompt Evaluation"

# Providers - Models to evaluate
# runSerially: true ensures ALL tests run against model 1 before ANY tests run against model 2
providers:
  - id: ollama:chat:gemma3:12b
    label: Gemma3-12B
    config:
      temperature: 0.1
  - id: ollama:chat:qwen3:8b
    label: Qwen3-8B
    config:
      temperature: 0.1

# Run all prompts against one model before switching to the next
# This prevents GPU memory thrashing from constant model loading/unloading
evaluateOptions:
  maxConcurrency: 1
  runSerially: true

# Default prompt (category detection)
prompts:
  - file://prompts/category_detection.txt

# Default test config - strip code fences before parsing
defaultTest:
  options:
    transform: |
      // Strip markdown code fences if present
      let text = output.trim();
      if (text.startsWith('```json')) text = text.slice(7);
      else if (text.startsWith('```')) text = text.slice(3);
      if (text.endsWith('```')) text = text.slice(0, -3);
      return text.trim();

# Test cases for category detection
tests:
  - vars:
      log_entry: "Had a great workout this morning - ran 5k in 25 minutes"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "physical_activity";

  - vars:
      log_entry: "Feeling really anxious about tomorrow's presentation"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "stress_anxiety" || data.category === "mental_state";

  - vars:
      log_entry: "Had eggs and toast for breakfast with orange juice"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "nutrition";

  - vars:
      log_entry: "Slept terribly last night, kept waking up every hour"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "sleep";

  - vars:
      log_entry: "Had two cups of coffee and took my daily vitamins"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "substances";

  - vars:
      log_entry: "Headache started around noon, feels like tension"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "physical_symptoms";

  - vars:
      log_entry: "Had a great lunch with Sarah, caught up on everything"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "social_interaction" || data.category === "nutrition";

  - vars:
      log_entry: "Super focused today, finished the quarterly report"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const data = JSON.parse(output);
          return data.category === "work_productivity" || data.category === "mental_state";

# Output
outputPath: ./output
